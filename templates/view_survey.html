<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û–ø—Ä–æ—Å/–¢–µ—Å—Ç</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="/static/css/odometer.css">
    <link rel="stylesheet" href="/static/css/animate.css">
    <link rel="stylesheet" href="/static/css/nice-select.css">
    <link rel="stylesheet" href="/static/css/magnific-popup.css">
    <link rel="stylesheet" href="/static/css/main.css">
    
    <!-- –§–∞–≤–∏–∫–æ–Ω -->
    <link rel="icon" href="/static/img/favicon/favicon.png" type="image/x-icon">
    
    <!-- –ú–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ -->
    <meta name="description" content="–û–Ω–ª–∞–π–Ω –æ–ø—Ä–æ—Å/—Ç–µ—Å—Ç">
    
    <!-- Open Graph –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
    <meta property="og:title" content="–°–∏—Å—Ç–µ–º–∞ –æ–Ω–ª–∞–π–Ω –æ–ø—Ä–æ—Å–æ–≤ –∏ —Ç–µ—Å—Ç–æ–≤" />
    <meta property="og:description" content="–°–∏—Å—Ç–µ–º–∞ –æ–Ω–ª–∞–π–Ω –æ–ø—Ä–æ—Å–æ–≤ –∏ —Ç–µ—Å—Ç–æ–≤" />
    <meta property="og:url" content="https://somnium.kz/survey/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://somnium.kz/static/img/tab/create-survey.png" />
    
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ Open Graph –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
    <meta property="og:site_name" content="somnium.kz" />
    <meta property="og:locale" content="ru_RU" />
    
    <!-- Twitter Cards (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="–°–∏—Å—Ç–µ–º–∞ –æ–Ω–ª–∞–π–Ω –æ–ø—Ä–æ—Å–æ–≤ –∏ —Ç–µ—Å—Ç–æ–≤">
    <meta name="twitter:description" content="–°–∏—Å—Ç–µ–º–∞ –æ–Ω–ª–∞–π–Ω –æ–ø—Ä–æ—Å–æ–≤ –∏ —Ç–µ—Å—Ç–æ–≤">
    <meta name="twitter:image" content="https://somnium.kz/static/img/tab/create-survey.png">

    <style>
        :root {
            --primary-color: #4a6bff;
            --primary-light: #e8edff;
            --primary-dark: #3756db;
            --secondary-color: #ff6b6b;
            --text-color: #2c3e50;
            --text-light: #6c757d;
            --bg-color: #f8faff;
            --card-bg: #ffffff;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
            --animation-speed: 0.3s;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--text-color);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 0.8rem;
            color: var(--primary-color);
        }

        h2 {
            font-size: 1.6rem;
            margin: 2rem 0 1.5rem;
            position: relative;
            padding-bottom: 0.5rem;
        }

        h2:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px;
        }

        p {
            margin-bottom: 1.5rem;
            font-size: 1.05rem;
            color: #505965;
        }

        .survey-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background-color: var(--card-bg);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            margin-top: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .survey-header {
            position: relative;
            margin: -2rem -2rem 2rem -2rem;
            padding: 2.5rem 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .survey-header h1 {
            color: white;
            margin-bottom: 0.8rem;
            font-weight: 700;
        }

        .survey-header p {
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 0;
            font-size: 1.1rem;
            max-width: 700px;
        }

        .survey-header .badge {
            position: absolute;
            right: 2rem;
            top: 2rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 30px;
            padding: 0.5rem 1.2rem;
            font-weight: 500;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
        }

        .form-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
            transition: transform var(--animation-speed) ease;
        }

        .form-section:hover {
            transform: translateY(-5px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-control {
            border-radius: var(--border-radius-sm);
            border: 1px solid #e0e6ed;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all var(--animation-speed) ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.15);
        }

        label {
            color: #495057;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-check {
            margin-bottom: 0.75rem;
            padding-left: 2rem;
            position: relative;
        }

        .form-check-input {
            position: absolute;
            margin-top: 0.25rem;
            margin-left: -2rem;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #cfd8dc;
            border-radius: 3px;
            transition: all 0.2s ease-in-out;
        }

        .form-check-input[type="radio"] {
            border-radius: 50%;
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .form-check-label {
            cursor: pointer;
            padding-top: 0.2rem;
            font-weight: 400;
            transition: color 0.2s ease;
        }

        .form-check:hover .form-check-label {
            color: var(--primary-color);
        }

        .text-field-group {
            position: relative;
            display: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            background-color: var(--primary-light);
            padding: 1rem;
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--primary-color);
        }

        .char-counter {
            position: absolute;
            right: 1rem;
            bottom: 1rem;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .btn {
            border-radius: 30px;
            padding: 0.75rem 1.75rem;
            font-weight: 500;
            transition: all var(--animation-speed) ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74, 107, 255, 0.25);
        }

        .btn-primary:focus {
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.3);
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }

        .btn-primary:hover::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                opacity: 1;
                transform: scale(0, 0) translate(-50%, -50%);
            }
            100% {
                opacity: 0;
                transform: scale(20, 20) translate(-50%, -50%);
            }
        }

        .invalid-feedback {
            display: none;
            color: var(--secondary-color);
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            z-index: 1000;
            width: 0;
            transition: width 0.3s ease;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ */
        .survey-question {
            transition: all 0.4s ease;
            transform: translateY(20px);
            opacity: 0;
        }

        .survey-question.visible {
            transform: translateY(0);
            opacity: 1;
        }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö radio –∏ checkbox */
        .custom-control {
            position: relative;
            padding-left: 2.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            font-weight: 400;
        }

        .custom-control-input {
            position: absolute;
            z-index: -1;
            opacity: 0;
        }

        .custom-control-label {
            position: relative;
            margin-bottom: 0;
            vertical-align: top;
            cursor: pointer;
            padding-top: 0.2rem;
        }

        .custom-control-label::before {
            position: absolute;
            top: 0.2rem;
            left: -2.5rem;
            display: block;
            width: 1.5rem;
            height: 1.5rem;
            content: "";
            background-color: #fff;
            border: 2px solid #cfd8dc;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .custom-radio .custom-control-label::before {
            border-radius: 50%;
        }

        .custom-checkbox .custom-control-label::before {
            border-radius: 4px;
        }

        .custom-control-input:checked ~ .custom-control-label::before {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .custom-control-label::after {
            position: absolute;
            top: 0.2rem;
            left: -2.5rem;
            display: block;
            width: 1.5rem;
            height: 1.5rem;
            content: "";
            background-repeat: no-repeat;
            background-position: center;
            background-size: 0.8rem;
        }

        .custom-checkbox .custom-control-input:checked ~ .custom-control-label::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
        }

        .custom-radio .custom-control-input:checked ~ .custom-control-label::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –±–ª–æ–∫–æ–≤ */
        .promo-block {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: var(--border-radius);
            margin: 2rem 0;
            padding: 1.25rem;
            transition: transform var(--animation-speed) ease;
            border: 1px solid #dee2e6;
        }

        .promo-block:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .logo img {
            width: 100%;
            height: auto;
        }

        /* –ë–æ–∫–æ–≤–∞—è —Ä–µ–∫–ª–∞–º–∞ */
        .side-ad {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 250px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 100;
            overflow: hidden;
            transition: all var(--animation-speed) ease;
        }

        .side-ad:hover {
            transform: translateY(-50%) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .side-ad-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1rem;
            font-weight: 600;
            text-align: center;
            font-size: 1.1rem;
        }

        .side-ad-content {
            padding: 1.5rem;
        }

        .service-list {
            list-style: none;
            padding: 0;
            margin-bottom: 1.5rem;
        }

        .service-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .service-icon {
            margin-right: 0.75rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .service-text {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .ad-cta {
            display: block;
            text-align: center;
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 1.5rem;
            transition: all var(--animation-speed) ease;
        }

        .ad-cta:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }

        .contact-info {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .survey-question {
            animation-delay: calc(var(--index) * 0.1s);
        }

        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
        @media (max-width: 992px) {
            .side-ad {
                display: none;
            }
            
            .survey-container {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .survey-header {
                padding: 2rem 1.5rem;
                margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            }
        }

        @media (max-width: 768px) {
            .survey-container {
                padding: 1rem;
            }
            
            .survey-header {
                padding: 1.5rem 1rem;
                margin: -1rem -1rem 1rem -1rem;
            }
            
            .form-section {
                padding: 1.5rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.4rem;
            }
            
            .survey-header .badge {
                position: static;
                display: inline-block;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }
        }
        
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è UX */
        .spinner-wrapper {
            display: inline-block;
            margin-right: 10px;
            display: none;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –æ–ø—Ä–æ—Å–∞ */
        .survey-progress {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            margin-bottom: 2rem;
            border-radius: 3px;
            overflow: hidden;
            z-index: 10;
        }
        
        .survey-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
<div class="progress-bar" id="progress-bar"></div>

<div class="container survey-container" id="survey-content" style="display: none;">
    {% if survey %}
        <div class="survey-header">
            <h1>{{ survey.title }}</h1>
            <p>{{ survey.description }}</p>
            <span class="badge">
                {% if survey.survey_type == 'anon_survey' %}
                    <i class="fas fa-user-secret mr-1"></i> –ê–Ω–æ–Ω–∏–º–Ω—ã–π –æ–ø—Ä–æ—Å
                {% elif survey.survey_type == 'anon_test' %}
                    <i class="fas fa-clipboard-check mr-1"></i> –ê–Ω–æ–Ω–∏–º–Ω—ã–π —Ç–µ—Å—Ç
                {% elif survey.survey_type == 'id_survey' %}
                    <i class="fas fa-poll mr-1"></i> –û–ø—Ä–æ—Å
                {% elif survey.survey_type == 'id_test' %}
                    <i class="fas fa-tasks mr-1"></i> –¢–µ—Å—Ç
                {% else %}
                    <i class="fas fa-question-circle mr-1"></i> –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø
                {% endif %}
            </span>
        </div>

        <div class="survey-progress">
            <div class="survey-progress-bar" id="survey-progress-bar"></div>
        </div>

        {% if survey.survey_type in ['id_survey', 'id_test'] %}
            <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
            <div class="form-section fade-in">
                <h2><i class="fas fa-user mr-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ</h2>
                <form id="participant-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="first_name">–ò–º—è</label>
                                <input type="text" class="form-control" id="first_name" name="first_name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
                                <div class="invalid-feedback">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="last_name">–§–∞–º–∏–ª–∏—è</label>
                                <input type="text" class="form-control" id="last_name" name="last_name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é">
                                <div class="invalid-feedback">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="patronymic">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                                <input type="text" class="form-control" id="patronymic" name="patronymic" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –æ—Ç—á–µ—Å—Ç–≤–æ">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="iin">–ò–ò–ù</label>
                                <input type="text" class="form-control" id="iin" name="iin" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ò–ò–ù">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="phone_number">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                                <input type="text" class="form-control" id="phone_number" name="phone_number" placeholder="+7 (XXX) XXX-XX-XX">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        {% endif %}

        <div class="form-section fade-in">
            <h2><i class="fas fa-question-circle mr-2"></i>–í–æ–ø—Ä–æ—Å—ã</h2>
            <form id="survey-form">
                <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è session_id -->
                <input type="hidden" name="session_id" id="session_id" value="">
                
                {% for question in questions %}
                <div class="survey-question mb-4" id="question_{{ question.id }}" style="--index: {{ loop.index }}">
                    <div class="question-header">
                        <h5 class="question-number"><span class="badge badge-primary mr-2">{{ loop.index }}</span>{{ question.text }}</h5>
                    </div>
                    
                    {% if question.choices %}
                        {% if question.question_type == 'single' %}
                            {% for choice in question.choices %}
                                {% if choice.answer_type == 'choice' %}
                                <div class="custom-control custom-radio">
                                    <input class="custom-control-input" type="radio" name="question_{{ question.id }}" id="choice_{{ choice.id }}" value="{{ choice.id }}" required>
                                    <label class="custom-control-label" for="choice_{{ choice.id }}">
                                        {{ choice.text }}
                                    </label>
                                </div>
                                {% elif choice.answer_type == 'text_field' %}
                                <div class="custom-control custom-radio">
                                    <input class="custom-control-input" type="radio" name="question_{{ question.id }}" id="choice_{{ choice.id }}" value="{{ choice.id }}">
                                    <label class="custom-control-label" for="choice_{{ choice.id }}">
                                        {{ choice.text }}
                                    </label>
                                </div>
                                <div class="text-field-group">
                                    <input type="text" class="form-control" name="question_{{ question.id }}_text_{{ choice.id }}" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç" maxlength="250" data-error="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –ø–æ–ª–µ (–Ω–µ –±–æ–ª–µ–µ 250 —Å–∏–º–≤–æ–ª–æ–≤).">
                                    <small class="char-counter">0/250</small>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% elif question.question_type == 'multiple' %}
                            {% for choice in question.choices %}
                                {% if choice.answer_type == 'choice' %}
                                <div class="custom-control custom-checkbox">
                                    <input class="custom-control-input" type="checkbox" name="question_{{ question.id }}" id="choice_{{ choice.id }}" value="{{ choice.id }}">
                                    <label class="custom-control-label" for="choice_{{ choice.id }}">
                                        {{ choice.text }}
                                    </label>
                                </div>
                                {% elif choice.answer_type == 'text_field' %}
                                <div class="custom-control custom-checkbox">
                                    <input class="custom-control-input" type="checkbox" name="question_{{ question.id }}" id="choice_{{ choice.id }}" value="{{ choice.id }}">
                                    <label class="custom-control-label" for="choice_{{ choice.id }}">
                                        {{ choice.text }}
                                    </label>
                                </div>
                                <div class="text-field-group">
                                    <input type="text" class="form-control" name="question_{{ question.id }}_text_{{ choice.id }}" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç" maxlength="250" data-error="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –ø–æ–ª–µ (–Ω–µ –±–æ–ª–µ–µ 250 —Å–∏–º–≤–æ–ª–æ–≤).">
                                    <small class="char-counter">0/250</small>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% else %}
                        <!-- –ï—Å–ª–∏ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ -->
                        <div class="form-group">
                            <input type="text" class="form-control" name="question_{{ question.id }}_text" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç" required maxlength="250" data-error="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –ø–æ–ª–µ (–Ω–µ –±–æ–ª–µ–µ 250 —Å–∏–º–≤–æ–ª–æ–≤).">
                            <small class="char-counter">0/250</small>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
                
                <div class="text-center mt-5">
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-wrapper"><div class="spinner"></div></span>
                        <i class="fas fa-paper-plane mr-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
                    </button>
                </div>
            </form>
        </div>

        <div class="promo-block">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="logo">
                        <img src="{{ url_for('static', filename='img/logo/logo-black.png') }}" alt="f-img">
                    </div>
                </div>
                <div class="col">
                    <p class="mb-0 fw-semibold">–í—Å–µ –≤–∏–¥—ã —É—Å–ª—É–≥ IT –∫–æ–º–ø–∞–Ω–∏–∏. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ü–û, —Ä–µ–º–æ–Ω—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤...</p>
                </div>
                <div class="col-auto">
                    <a href="/" class="btn btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                </div>
            </div>
        </div>

        <div class="promo-block">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="logo">
                        <img src="{{ url_for('static', filename='img/logo/logo_animation.gif') }}" alt="f-img">
                    </div>
                </div>
                <div class="col">
                    <p class="mb-0 fw-semibold">–°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–æ–≤/—Ç–µ—Å—Ç–æ–≤ –æ–Ω–ª–∞–π–Ω!</p>
                </div>
                <div class="col-auto">
                    <a href="/survey" class="btn btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<div class="side-ad">
    <div class="side-ad-header">
        –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ –≤–∞—à—É —Ä–µ–∫–ª–∞–º—É
    </div>
    <div class="side-ad-content">
        <ul class="service-list">
            <li class="service-item">
                <div class="service-icon">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </div>
                <span class="service-text">–í–∏–¥–µ–æ—Ä–µ–∫–ª–∞–º–∞ –≤ –æ–ø—Ä–æ—Å–∞—Ö</span>
            </li>
            <li class="service-item">
                <div class="service-icon">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                    </svg>
                </div>
                <span class="service-text">–ë–∞–Ω–Ω–µ—Ä–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏</span>
            </li>
            <li class="service-item">
                <div class="service-icon">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </div>
                <span class="service-text">–ù–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</span>
            </li>
            <li class="service-item">
                <div class="service-icon">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zM9 19V9a2 2 0 012-2h2a2 2 0 012 2v10a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <span class="service-text">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
            </li>
        </ul>
        
        <a href="/contact" class="ad-cta">–£–∑–Ω–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</a>
        
        <div class="contact-info">
            <div>üíº –û—Ç–¥–µ–ª —Ä–µ–∫–ª–∞–º—ã</div>
            <div>üì± +7 (708) 128-72-46</div>
            <div>üìß kandarr4@gmail.com</div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/viewport-units-buggyfill/0.6.2/viewport.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.8/odometer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.survey-question').forEach(el => {
            observer.observe(el);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        function updateProgressBar() {
            const windowHeight = window.innerHeight;
            const fullHeight = document.body.offsetHeight;
            const scrolled = window.scrollY;
            const percentScrolled = (scrolled / (fullHeight - windowHeight)) * 100;
            
            document.getElementById('progress-bar').style.width = percentScrolled + '%';
        }
        
        window.addEventListener('scroll', updateProgressBar);
        updateProgressBar();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –æ–ø—Ä–æ—Å–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏
        function updateSurveyProgress() {
            const totalQuestions = document.querySelectorAll('.survey-question').length;
            let answeredQuestions = 0;
            
            document.querySelectorAll('.survey-question').forEach(question => {
                const questionId = question.id.split('_')[1];
                const radios = question.querySelectorAll(`input[name="question_${questionId}"][type="radio"]`);
                const checkboxes = question.querySelectorAll(`input[name="question_${questionId}"][type="checkbox"]`);
                const textInputs = question.querySelectorAll(`input[name="question_${questionId}_text"]`);
                
                if (radios.length > 0) {
                    // –î–ª—è —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–æ–∫
                    const checked = Array.from(radios).some(radio => radio.checked);
                    if (checked) answeredQuestions++;
                } else if (checkboxes.length > 0) {
                    // –î–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
                    const checked = Array.from(checkboxes).some(checkbox => checkbox.checked);
                    if (checked) answeredQuestions++;
                } else if (textInputs.length > 0) {
                    // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
                    const filled = Array.from(textInputs).some(input => input.value.trim() !== '');
                    if (filled) answeredQuestions++;
                }
            });
            
            const progressPercentage = (answeredQuestions / totalQuestions) * 100;
            document.getElementById('survey-progress-bar').style.width = progressPercentage + '%';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ –ø–æ–ª—è
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', updateSurveyProgress);
            input.addEventListener('input', updateSurveyProgress);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        updateSurveyProgress();

        {% if is_inactive %}
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–± –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º –æ–ø—Ä–æ—Å–µ
            Swal.fire({
                icon: 'info',
                title: '–û–ø—Ä–æ—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
                text: '–≠—Ç–æ—Ç –æ–ø—Ä–æ—Å –æ—Ç–∫–ª—é—á–µ–Ω –∏–ª–∏ –µ—â–µ –Ω–µ –Ω–∞—á–∞—Ç.',
                allowOutsideClick: false,
                showConfirmButton: false
            });
        {% endif %}

        {% if show_alert %}
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—à–∏–±–∫–∏)
            Swal.fire({
                icon: '{{ alert_type }}', // 'error', 'success', 'info', 'warning', 'question'
                title: '{{ alert_title }}',
                text: '{{ alert_text }}',
                allowOutsideClick: false,
                showConfirmButton: true
            });
        {% endif %}

        {% if show_password_modal and survey %}
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–ø—Ä–æ—Å–∞ –¥–æ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
            $('#survey-content').hide();

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
            Swal.fire({
                title: '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–ø—Ä–æ—Å—É',
                input: 'password',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                confirmButtonText: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
                showLoaderOnConfirm: true,
                preConfirm: (password) => {
                    return $.ajax({
                        url: '/survey/{{ survey.url }}/check_password',
                        method: 'POST',
                        data: { password: password },
                        headers: {
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    }).then(response => {
                        if (!response.success) {
                            throw new Error(response.message);
                        }
                    }).catch(error => {
                        if (error.responseJSON && error.responseJSON.message) {
                            Swal.showValidationMessage(`–û—à–∏–±–∫–∞: ${error.responseJSON.message}`);
                        } else {
                            Swal.showValidationMessage(`–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.`);
                        }
                    });
                },
                allowOutsideClick: false, // –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∏–∫–æ–º –≤–Ω–µ –æ–∫–Ω–∞
                allowEscapeKey: false // –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–≤–∏—à–µ–π Esc
            }).then((result) => {
                if (result.isConfirmed) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–ø—Ä–æ—Å–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    $('#survey-content').fadeIn(500);
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
                    handleTextFields();
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
                    initializeCharCounters();
                }
            });

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
            function handleTextFields() {
                $('.custom-control-input').each(function() {
                    var input = $(this);
                    var nameParts = input.attr('name').split('_');
                    var questionId = nameParts[1];
                    var choiceId = input.val();
                    var textField = $('input[name="question_' + questionId + '_text_' + choiceId + '"]');

                    if (input.is(':checked')) {
                        textField.closest('.text-field-group').slideDown(300);
                    } else {
                        textField.closest('.text-field-group').slideUp(300);
                        textField.val(''); // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏
                        textField.popover('dispose'); // –£–±–∏—Ä–∞–µ–º Popover
                        textField.removeClass('is-invalid'); // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –æ—à–∏–±–∫–∏
                        textField.siblings('.invalid-feedback').hide(); // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                        textField.siblings('.char-counter').text('0/250'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                    }
                });
            }

            // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
            $('.text-field-group').hide();

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —á–µ–∫–±–æ–∫—Å–∞—Ö/—Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∞—Ö
            $('.custom-control-input').on('change', function() {
                handleTextFields();
                updateSurveyProgress();
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
            function initializeCharCounters() {
                $('.char-counter').each(function() {
                    var input = $(this).siblings('input[type="text"]');
                    $(input).on('input', function() {
                        var currentLength = $(this).val().length;
                        $(this).siblings('.char-counter').text(currentLength + '/250');
                    });

                    // –°–∫—Ä—ã—Ç–∏–µ Popover –ø—Ä–∏ –≤–≤–æ–¥–µ
                    $(input).on('input', function() {
                        if ($(this).hasClass('is-invalid')) {
                            $(this).popover('dispose');
                            $(this).removeClass('is-invalid');
                            $(this).siblings('.invalid-feedback').hide();
                            $(this).siblings('.char-counter').text($(this).val().length + '/250'); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                        }
                        updateSurveyProgress();
                    });
                });
            }

            // –í—ã–∑–æ–≤–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            handleTextFields();
            initializeCharCounters();
        {% elif survey %}
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–ø—Ä–æ—Å–∞, –µ—Å–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
            $('#survey-content').fadeIn(500);

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
            function handleTextFields() {
                $('.custom-control-input').each(function() {
                    var input = $(this);
                    var nameParts = input.attr('name').split('_');
                    var questionId = nameParts[1];
                    var choiceId = input.val();
                    var textField = $('input[name="question_' + questionId + '_text_' + choiceId + '"]');

                    if (input.is(':checked')) {
                        textField.closest('.text-field-group').slideDown(300);
                    } else {
                        textField.closest('.text-field-group').slideUp(300);
                        textField.val(''); // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏
                        textField.popover('dispose'); // –£–±–∏—Ä–∞–µ–º Popover
                        textField.removeClass('is-invalid'); // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –æ—à–∏–±–∫–∏
                        textField.siblings('.invalid-feedback').hide(); // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                        textField.siblings('.char-counter').text('0/250'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                    }
                });
            }

            // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
            $('.text-field-group').hide();

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —á–µ–∫–±–æ–∫—Å–∞—Ö/—Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∞—Ö
            $('.custom-control-input').on('change', function() {
                handleTextFields();
                updateSurveyProgress();
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
            function initializeCharCounters() {
                $('.char-counter').each(function() {
                    var input = $(this).siblings('input[type="text"]');
                    $(input).on('input', function() {
                        var currentLength = $(this).val().length;
                        $(this).siblings('.char-counter').text(currentLength + '/250');
                    });

                    // –°–∫—Ä—ã—Ç–∏–µ Popover –ø—Ä–∏ –≤–≤–æ–¥–µ
                    $(input).on('input', function() {
                        if ($(this).hasClass('is-invalid')) {
                            $(this).popover('dispose');
                            $(this).removeClass('is-invalid');
                            $(this).siblings('.invalid-feedback').hide();
                            $(this).siblings('.char-counter').text($(this).val().length + '/250'); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                        }
                        updateSurveyProgress();
                    });
                });
            }

            // –í—ã–∑–æ–≤–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            handleTextFields();
            initializeCharCounters();
        {% endif %}

        {% if not is_inactive and survey %}
            // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏
            let sessionInitialized = false;

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏
            function initializeSession() {
                if (sessionInitialized) return;

                $.ajax({
                    url: '/survey/{{ survey.url }}/init',
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#session_id').val(response.session_id);
                            sessionInitialized = true;
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '–û—à–∏–±–∫–∞',
                                text: response.message
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: '–û—à–∏–±–∫–∞',
                            text: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏.'
                        });
                    }
                });
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞ –Ω–∞ –ª—é–±–æ–π —á–µ–∫–±–æ–∫—Å –∏–ª–∏ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫—É
            $('.custom-control-input').one('click', function() {
                initializeSession();
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –æ–ø—Ä–æ—Å–∞
            $('#survey-form').on('submit', function(event) {
                event.preventDefault();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
                $('.spinner-wrapper').show();
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                $('button[type="submit"]').prop('disabled', true);
                
                // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—à–∏–±–æ–∫ –∏ Popover
                $('.is-invalid').removeClass('is-invalid');
                $('.invalid-feedback').hide();
                $('.form-control').popover('dispose');

                // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                var isValid = true;
                var firstErrorField = null;

                // –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö Popover –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
                $('.form-control').popover('dispose');

                $('.text-field-group').each(function() {
                    var textInput = $(this).find('input[type="text"]');
                    var choiceInput = $(this).prev('.custom-control').find('.custom-control-input');
                    var errorMessage = textInput.data('error');

                    if (choiceInput.is(':checked')) {
                        var value = textInput.val().trim();
                        if (value === '') {
                            isValid = false;
                            textInput.addClass('is-invalid');
                            textInput.siblings('.invalid-feedback').text('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –ø–æ–ª–µ.').show();
                            textInput.popover({
                                content: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –ø–æ–ª–µ.',
                                trigger: 'manual',
                                placement: 'right'
                            }).popover('show');
                            if (!firstErrorField) {
                                firstErrorField = textInput;
                            }
                        } else if (value.length > 250) {
                            isValid = false;
                            textInput.addClass('is-invalid');
                            textInput.siblings('.invalid-feedback').text('–¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 250 —Å–∏–º–≤–æ–ª–æ–≤.').show();
                            textInput.popover({
                                content: '–¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 250 —Å–∏–º–≤–æ–ª–æ–≤.',
                                trigger: 'manual',
                                placement: 'right'
                            }).popover('show');
                            if (!firstErrorField) {
                                firstErrorField = textInput;
                            }
                        }
                    }
                });

                // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –±–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
                $('input[required]').not('input[type="radio"], input[type="checkbox"]').each(function() {
                    var textInput = $(this);
                    var errorMessage = textInput.data('error');
                    var value = textInput.val().trim();
                    if (value === '') {
                        isValid = false;
                        textInput.addClass('is-invalid');
                        textInput.siblings('.invalid-feedback').text('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –ø–æ–ª–µ.').show();
                        textInput.popover({
                            content: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –ø–æ–ª–µ.',
                            trigger: 'manual',
                            placement: 'right'
                        }).popover('show');
                        if (!firstErrorField) {
                            firstErrorField = textInput;
                        }
                    } else if (value.length > 250) {
                        isValid = false;
                        textInput.addClass('is-invalid');
                        textInput.siblings('.invalid-feedback').text('–¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 250 —Å–∏–º–≤–æ–ª–æ–≤.').show();
                        textInput.popover({
                            content: '–¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 250 —Å–∏–º–≤–æ–ª–æ–≤.',
                            trigger: 'manual',
                            placement: 'right'
                        }).popover('show');
                        if (!firstErrorField) {
                            firstErrorField = textInput;
                        }
                    }
                });

                if (!isValid) {
                    // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    $('.spinner-wrapper').hide();
                    
                    // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                    $('button[type="submit"]').prop('disabled', false);
                    
                    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
                    $('html, body').animate({
                        scrollTop: firstErrorField.closest('.mb-4, .form-group').offset().top - 20
                    }, 500);
                    return;
                }

                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                var formData = $(this).serializeArray();

                {% if survey.survey_type in ['id_survey', 'id_test'] %}
                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
                    var participantData = $('#participant-form').serializeArray();
                    formData = formData.concat(participantData);
                {% endif %}

                $.ajax({
                    url: '/survey/{{ survey.url }}/submit',
                    method: 'POST',
                    data: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        $('.spinner-wrapper').hide();
                        
                        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                        $('button[type="submit"]').prop('disabled', false);
                        
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!',
                                text: response.message,
                                confirmButtonText: '–û–∫'
                            }).then(() => {
                                window.location.href = '/'; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '–û—à–∏–±–∫–∞',
                                text: response.message
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        $('.spinner-wrapper').hide();
                        
                        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                        $('button[type="submit"]').prop('disabled', false);
                        
                        Swal.fire({
                            icon: 'error',
                            title: '–û—à–∏–±–∫–∞',
                            text: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö.'
                        });
                    }
                });
            });
        {% endif %}
    });
</script>

</body>
</html>